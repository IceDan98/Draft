<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoL and Wild Rift Drafter - v6.0</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
    <style>
        /* style.css - –í—Å—Ç—Ä–æ–µ–Ω–æ –≤ HTML v6.0 */
        :root {
            /* Base Sizes */
            --gap-size: 0.5rem;
            --gap-half: calc(var(--gap-size) / 2);
            --gap-double: calc(var(--gap-size) * 2);

            /* Sizes (vmin/vh for scalability) */
            --ban-size: 5.5vmin;
            --card-size: 8vh;
            --nick-height: 3.5vh;
            --nick-font-size: 2.8vh;
            --button-size: 4.2vh;
            --timer-font-size: 2vh;
            --score-size: 4.2vh;
            --score-font-size: 2vh;
            --filter-button-size: 3.8vh;
            --global-ban-icon-size: calc(var(--card-size) * 0.8);

            /* Minimum Sizes */
            --ban-min-size: 28px;
            --pick-min-height: 55px;
            --card-min-size: 42px;
            --nick-min-height: 16px;
            --button-min-size: 28px;
            --score-min-size: 28px;
            --team-name-min-height: 30px;
            --team-col-min-width: 240px;
            --global-ban-icon-min-size: 35px;

            /* Colors - Dark Theme (Default) */
            --color-background: #0a0f1f;
            --color-background-gradient-end: #0f0a1a;
            --color-surface-1: #10182f;
            --color-surface-2: #1a2340;
            --color-text-primary: #e0e8f0;
            --color-text-secondary: #8095b0;
            --color-text-placeholder: #556a88;
            --color-border: #2a3858;
            --color-border-medium: #405075;
            --color-accent-gold: #c8aa6e;
            --color-accent-blue: #50a0f0;
            --color-accent-red: #f05050;
            --color-accent-green: #40f0a0;
            --color-accent-purple: #a070f0;

            --color-blue-team: var(--color-accent-blue);
            --color-red-team: var(--color-accent-red);

            --color-blue-bg-transparent: rgba(80, 160, 240, 0.1);
            --color-red-bg-transparent: rgba(240, 80, 80, 0.1);
            --color-grid-bg-transparent: rgba(26, 35, 64, 0.5);

            --color-tooltip-bg: rgba(10, 15, 31, 0.9);
            --color-tooltip-text: var(--color-text-primary);

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.2);
            --shadow-glow-gold: 0 0 10px 0px rgba(200, 170, 110, 0.5);
            --shadow-glow-blue: 0 0 10px 0px rgba(80, 160, 240, 0.5);
            --shadow-glow-red: 0 0 8px 0px rgba(240, 80, 80, 0.4);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            scrollbar-color: var(--color-border-medium) var(--color-surface-1);
            scrollbar-width: thin;
        }
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: var(--color-surface-1); }
        body::-webkit-scrollbar-thumb { background-color: var(--color-border-medium); border-radius: 4px; border: 2px solid var(--color-surface-1); }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            background-image: linear-gradient(45deg, var(--color-background), var(--color-background-gradient-end));
            color: var(--color-text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 2600px;
            padding: var(--gap-size);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for absolute positioning of admin button */
        }

        .page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        /* --- Home Page Styles --- */
        #homePage {
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #homeTitle {
            font-family: 'Cinzel', serif;
            color: var(--color-accent-gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: clamp(2rem, 6vmin, 3.5rem);
            margin-bottom: 2rem;
        }
        /* Styles for new home page elements */
        .lobby-input {
            background-color: var(--color-surface-2);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        .lobby-input::placeholder {
            color: var(--color-text-placeholder);
        }
        #createLobbyButton {
            background-color: var(--color-accent-blue);
            color: var(--color-background);
            border-color: var(--color-accent-blue);
            padding: 0.8rem 2rem;
            font-size: clamp(1rem, 2.5vh, 1.3rem);
            min-width: 150px;
            font-weight: 600;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-md);
            margin-top: 1rem;
        }
        #createLobbyButton:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--color-accent-blue), #fff 15%);
            box-shadow: var(--shadow-lg);
        }
         #createLobbyButton:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }
         #lobbyLinksDisplay {
            margin-top: 2rem;
            background-color: var(--color-surface-1);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
            max-width: 90%;
            word-wrap: break-word; /* Ensure long links wrap */
            text-align: left; /* Align text left */
         }
         #lobbyLinksDisplay p {
            margin-bottom: 0.75rem; /* Increased spacing */
            font-size: clamp(0.8rem, 2vmin, 1rem); /* Responsive font size */
         }
         #lobbyLinksDisplay strong {
            color: var(--color-accent-gold);
            display: inline-block;
            min-width: 100px; /* Align labels */
         }
         #lobbyLinksDisplay a, #lobbyLinksDisplay span { /* Style generated links/text */
             color: var(--color-accent-blue);
             display: inline-block;
             margin-left: 0.5rem;
             word-break: break-all; /* Break long URLs */
             background-color: var(--color-surface-2); /* Add background */
             padding: 0.2rem 0.4rem; /* Add padding */
             border-radius: 0.25rem; /* Rounded corners */
             cursor: pointer; /* Indicate clickability */
             border: 1px solid var(--color-border-medium);
         }
         #lobbyLinksDisplay a:hover {
             text-decoration: none;
             background-color: var(--color-border-medium);
             color: var(--color-text-primary);
         }
         .copy-button {
            background-color: var(--color-accent-purple);
            color: var(--color-background);
            border: none;
            padding: 0.1rem 0.4rem;
            font-size: 0.75em;
            border-radius: 0.25rem;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: background-color 0.2s;
         }
         .copy-button:hover {
            background-color: color-mix(in srgb, var(--color-accent-purple), #fff 15%);
         }

        /* --- Admin Button Style --- */
        #adminButton {
            position: absolute;
            top: var(--gap-double); /* Adjust spacing */
            right: var(--gap-double); /* Adjust spacing */
            z-index: 10; /* Ensure it's above other elements */
            background-color: var(--color-accent-gold);
            color: var(--color-background);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: clamp(0.8rem, 2vmin, 1rem);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: var(--shadow-md);
            border: none;
        }
        #adminButton:hover {
            background-color: color-mix(in srgb, var(--color-accent-gold), #fff 15%);
            box-shadow: var(--shadow-lg);
        }
        #adminButton:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }


        /* --- Draft Page Styles --- */
        #draftPage {
             height: 100%;
             overflow: hidden;
        }


        .team-name {
            font-family: 'Cinzel', serif;
        }
        .nickname-input {
             font-family: 'Inter', sans-serif;
        }

        #loadingIndicator {
            position: fixed; /* Ensure it covers everything */
            inset: 0;
            background-color: rgba(10, 15, 31, 0.85); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* High z-index */
            transition: opacity 0.5s ease-out;
        }
        #loadingIndicator.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #mainLayout {
            display: grid;
            grid-template-rows: auto 1fr;
            grid-template-columns: auto minmax(300px, 1fr) auto;
            gap: var(--gap-size);
            height: 100%;
            width: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        #mainLayout:not(.hidden) {
            opacity: 1;
        }

        #topRowContainer {
            grid-column: 1 / -1;
            grid-row: 1;
            display: grid;
            grid-template-columns: subgrid;
            gap: var(--gap-size);
            align-items: center;
            margin-bottom: var(--gap-size);
            min-height: calc(var(--button-size) + var(--gap-size));
        }

        .top-row-cell {
            display: flex;
            align-items: center;
            gap: var(--gap-size);
            min-width: 0;
        }
        .top-row-cell.blue-info { grid-column: 1; justify-content: flex-start; }
        .top-row-cell.center-controls { grid-column: 2; justify-content: center; }
        .top-row-cell.red-info { grid-column: 3; justify-content: flex-end; }

        .center-controls-wrapper {
            display: grid;
            grid-template-columns: minmax(0, 1fr) max-content max-content max-content minmax(0, 1fr);
            align-items: center;
            gap: var(--gap-size);
            width: 100%;
        }

        .team-name {
            width: auto;
            max-width: 300px;
            text-align: center;
            font-size: clamp(1.2rem, 3.5vmin, 1.8rem);
            font-weight: 600;
            flex-shrink: 1;
            min-height: var(--team-name-min-height);
            line-height: var(--team-name-min-height);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0.2rem 0.4rem;
            border-radius: 0.375rem;
            background-color: transparent;
            transition: background-color 0.2s ease, color 0.2s ease;
            cursor: default; /* Default cursor */
        }
        .team-name[contenteditable="true"] { /* Only editable when true */
             cursor: text;
        }
        .team-name[contenteditable="true"]:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .team-name[contenteditable="true"]:focus {
            outline: 2px solid var(--color-accent-gold);
            background-color: rgba(0, 0, 0, 0.3);
            white-space: normal;
            overflow: visible;
            box-shadow: var(--shadow-glow-gold);
        }
        #blue-team-name-h2 { justify-self: end; text-align: right; color: var(--color-blue-team); }
        #red-team-name-h2 { justify-self: start; text-align: left; color: var(--color-red-team); }

        .score-input {
            width: var(--score-size);
            height: var(--score-size);
            min-width: var(--score-min-size);
            min-height: var(--score-min-size);
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--score-font-size);
            font-weight: 600;
            flex-shrink: 0;
            justify-self: center;
            background-color: var(--color-surface-1);
            cursor: default; /* Default cursor */
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .score-input[contenteditable="true"] { /* Only editable when true */
             cursor: text;
         }
        .score-input[contenteditable="true"]:hover {
             background-color: var(--color-surface-2);
             border-color: var(--color-border-medium);
        }
        .score-input[contenteditable="true"]:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            background-color: var(--color-surface-2);
            box-shadow: var(--shadow-glow-gold);
        }
        .score-input:empty::before {
            content: "0";
            color: var(--color-text-placeholder);
            font-style: normal;
        }
        #blue-score { color: var(--color-blue-team); }
        #red-score { color: var(--color-red-team); }

        .timer-display-button {
            font-family: 'Inter', sans-serif;
            font-size: var(--timer-font-size);
            font-weight: 600;
            color: var(--color-text-primary);
            min-width: 6ch;
            text-align: center;
            background-color: var(--color-accent-green);
            color: var(--color-background);
            border: none;
            padding: 0.2rem 0.6rem;
            border-radius: 0.375rem;
            height: var(--button-size);
            min-height: var(--button-min-size);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        .timer-display-button:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--color-accent-green), #fff 10%);
            box-shadow: var(--shadow-md);
        }
        .timer-display-button:disabled,
        .timer-display-button.timer-disabled {
            cursor: default;
            background-color: var(--color-surface-2);
            color: var(--color-text-secondary);
            opacity: 0.8;
            box-shadow: none;
        }
        .timer-display-button.timer-running {
            background-color: var(--color-surface-2);
            color: var(--color-text-primary);
            cursor: default;
            opacity: 1;
            box-shadow: none;
        }
        .timer-display-button.timer-ending {
            color: var(--color-accent-red);
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(240, 80, 80, 0.4); }
            50% { box-shadow: 0 0 5px 2px rgba(240, 80, 80, 0.2); }
        }


        .bans-container {
            display: flex;
            justify-content: center;
            gap: var(--gap-half);
            flex-shrink: 0;
        }

        #draftArea {
            grid-column: 1 / -1;
            grid-row: 2;
            display: grid;
            grid-template-columns: subgrid;
            gap: var(--gap-size);
            overflow: hidden;
            min-height: 0;
            align-items: stretch;
        }

        .team-column {
            min-width: var(--team-col-min-width);
            width: auto;
            max-width: 480px;
            flex: 0 1 var(--team-col-min-width);
            padding: var(--gap-size);
            border-radius: 0.5rem;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            scrollbar-width: none;
            transition: opacity 0.3s ease, filter 0.3s ease;
            border: 1px solid var(--color-border);
            background-color: rgba(16, 24, 47, 0.3);
        }
        .team-column.blue-column { background-color: var(--color-blue-bg-transparent); border-color: color-mix(in srgb, var(--color-blue-team), transparent 70%); }
        .team-column.red-column { background-color: var(--color-red-bg-transparent); border-color: color-mix(in srgb, var(--color-red-team), transparent 70%);}
        .team-column::-webkit-scrollbar { display: none; }

        .team-column.draft-disabled {
            pointer-events: none;
            opacity: 0.6;
            filter: grayscale(60%);
        }
        /* Style to visually indicate non-interactable column for other team */
        .team-column.role-disabled {
             opacity: 0.7;
             filter: grayscale(30%);
             pointer-events: none; /* Disable clicks on the column itself */
        }
        .team-column.role-disabled .pick-slot,
        .team-column.role-disabled .ban-slot {
             pointer-events: none; /* Disable clicks on slots */
             cursor: not-allowed;
        }
        .team-column.role-disabled .nickname-input {
            pointer-events: none; /* Disable nickname editing */
            cursor: not-allowed;
        }


        .picks-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--gap-size);
            flex-grow: 1;
            justify-content: space-around;
            width: 100%;
            min-height: 0;
            margin-top: var(--gap-size);
        }

        .pick-slot, .ban-slot {
            background-color: var(--color-surface-2);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            border-radius: 0.375rem;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        .ban-slot {
            width: var(--ban-size);
            height: var(--ban-size);
            min-width: var(--ban-min-size);
            min-height: var(--ban-min-size);
            border-radius: 0.25rem;
        }
        .pick-slot {
            min-height: var(--pick-min-height);
            width: 100%;
            height: auto;
            flex-grow: 1;
            position: relative;
        }
        .pick-slot img, .ban-slot img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
            z-index: 0;
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        .highlight-action {
            border-color: var(--color-accent-gold);
            box-shadow: var(--shadow-glow-gold);
            background-color: color-mix(in srgb, var(--color-surface-2), var(--color-accent-gold) 10%);
        }

        .swap-selected {
            border-color: var(--color-accent-blue);
            box-shadow: var(--shadow-glow-blue);
        }

        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .preview-flash > img { animation: flash 1s infinite ease-in-out; }

        .nickname-input[contenteditable="true"] {
            position: absolute;
            bottom: 5px;
            width: auto;
            max-width: calc(100% - 16px);
            z-index: 1;
            font-size: calc(var(--nick-font-size) * 0.9);
            font-weight: 500;
            color: #fff; /* White text for nickname */
            height: auto;
            min-height: var(--nick-min-height);
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 0.25rem;
            padding: 2px 6px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            pointer-events: auto;
            cursor: text;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 1.3;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid transparent;
        }
         .nickname-input:not([contenteditable="true"]) { /* Style non-editable nicknames */
             cursor: default;
             background-color: rgba(0, 0, 0, 0.4); /* Less prominent background */
             pointer-events: none;
         }

        [id^="blue-pick-"] .nickname-input { right: 8px; left: auto; text-align: right; }
        [id^="red-pick-"] .nickname-input { left: 8px; right: auto; text-align: left; }

        .nickname-input[contenteditable="true"]:empty::before {
            content: "–ù–∏–∫";
            color: #fff; /* White placeholder text */
            font-style: normal;
            opacity: 0.7; /* Make placeholder slightly transparent */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .nickname-input[contenteditable="true"]:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.8);
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            border: 1px solid var(--color-accent-gold);
            box-shadow: var(--shadow-glow-gold);
        }

        #championGridContainer {
            grid-column: 2;
            background-color: transparent;
            border-radius: 0.5rem;
            padding: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column; /* Keep column for overall structure */
            overflow: hidden;
            min-width: 300px;
            border: none;
        }

        #globallyBannedDisplay {
            flex-shrink: 0;
            margin-bottom: var(--gap-size);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--gap-half);
            width: 100%;
            min-height: calc(var(--global-ban-icon-min-size) + var(--gap-half));
            border-bottom: 1px solid var(--color-border);
            padding-bottom: var(--gap-half);
            transition: opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
        }
        #globallyBannedDisplay.hidden { opacity: 0; max-height: 0; margin-bottom: 0; padding-bottom: 0; border-bottom: none; overflow: hidden; }

        .global-bans-row { display: flex; justify-content: space-between; width: 100%; align-items: flex-start; gap: var(--gap-size); }
        #global-bans-blue, #global-bans-red { display: grid; grid-template-columns: repeat(5, auto); gap: var(--gap-half); align-items: center; min-height: var(--global-ban-icon-min-size); }
        #global-bans-blue { justify-items: start; }
        #global-bans-red { justify-items: end; }

        .global-ban-icon {
            width: var(--global-ban-icon-size);
            height: var(--global-ban-icon-size);
            min-width: var(--global-ban-icon-min-size);
            min-height: var(--global-ban-icon-min-size);
            background-size: cover;
            background-position: center;
            border-radius: 0.25rem;
            overflow: hidden;
            flex-shrink: 0;
            background-color: var(--color-surface-1);
            border: 1px solid var(--color-border);
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
            box-shadow: var(--shadow-sm);
        }
        .global-ban-icon img { display: block; width: 100%; height: 100%; object-fit: cover; filter: grayscale(90%) brightness(60%); }

        .search-controls-wrapper {
            display: flex;
            align-items: center;
            gap: var(--gap-half);
            margin-bottom: var(--gap-size); /* Keep margin bottom */
            flex-shrink: 0;
            overflow-x: auto;
            padding: var(--gap-half);
            background-color: var(--color-surface-1);
            border-radius: 0.375rem;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
            flex-wrap: wrap; /* Allow wrapping */
        }
        .search-controls-wrapper::-webkit-scrollbar { height: 4px; }
        .search-controls-wrapper::-webkit-scrollbar-track { background: transparent; }
        .search-controls-wrapper::-webkit-scrollbar-thumb { background-color: var(--color-border-medium); border-radius: 2px; }

        #championSearch {
            flex-grow: 1;
            flex-shrink: 1; /* Allow shrinking */
            font-size: clamp(0.85rem, 2vmin, 1rem);
            min-width: 100px; /* Allow smaller min width */
            height: var(--filter-button-size);
            min-height: 30px;
            background-color: var(--color-surface-2);
            border: 1px solid var(--color-border);
            border-radius: 0.25rem;
            padding: 0 0.5rem;
            color: var(--color-text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #championSearch::placeholder { color: var(--color-text-placeholder); }
        #championSearch:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: var(--shadow-glow-blue);
            background-color: var(--color-surface-1);
        }

        #roleFilterButtons { display: flex; gap: var(--gap-half); flex-shrink: 0; }

        .search-controls-wrapper .action-button { flex-shrink: 0; }

        .action-button {
            color: var(--color-text-primary);
            width: var(--button-size);
            height: var(--button-size);
            min-width: var(--button-min-size);
            min-height: var(--button-min-size);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease, color 0.2s ease, transform 0.1s ease;
            border: 1px solid var(--color-border);
            cursor: pointer;
            font-size: calc(var(--button-size) * 0.45);
            line-height: 1;
            flex-shrink: 0;
            background-color: var(--color-surface-2);
            box-shadow: var(--shadow-sm);
        }
        .action-button:hover:not(:disabled) {
            background-color: var(--color-border-medium);
            border-color: var(--color-text-secondary);
            color: #fff;
            box-shadow: var(--shadow-md);
        }
        .action-button:active:not(:disabled) {
            transform: scale(0.95);
            background-color: var(--color-border);
            box-shadow: none;
        }
        .action-button:focus-visible {
            outline: 2px solid var(--color-accent-blue);
            outline-offset: 1px;
            box-shadow: var(--shadow-glow-blue);
            border-color: var(--color-accent-blue);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            background-color: var(--color-surface-2);
            border-color: var(--color-border);
            color: var(--color-text-secondary);
        }

        .icon-button { font-size: calc(var(--button-size) * 0.55); width: var(--button-size); }

        /* Confirm button specific styles - Wider, Inline */
        #confirmPickBanButton {
             /* Make it wider */
             width: auto; /* Allow content padding to define width */
             min-width: calc(var(--button-size) * 3); /* Minimum 3x base button width */
             padding-left: 1.5rem; /* Add horizontal padding */
             padding-right: 1.5rem;
             /* Keep base height */
             height: var(--button-size);
             min-height: var(--button-min-size);
             /* Adjust font size if needed */
             font-size: calc(var(--button-size) * 0.55);
             /* Specific background/color */
             background-color: var(--color-accent-green);
             color: var(--color-background);
             border-color: var(--color-accent-green);
        }
        #confirmPickBanButton:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--color-accent-green), #fff 15%);
        }


        /* Other Specific Button Overrides */
        #resetButton { background-color: var(--color-accent-red); color: var(--color-background); border-color: var(--color-accent-red);}
        #resetButton:hover:not(:disabled) { background-color: color-mix(in srgb, var(--color-accent-red), #fff 15%); }
        #nextDraftButton { background-color: var(--color-accent-gold); color: var(--color-background); border-color: var(--color-accent-gold); }
        #nextDraftButton:hover:not(:disabled) { background-color: color-mix(in srgb, var(--color-accent-gold), #fff 15%); }
        #priorityFilterButton { background-color: var(--color-surface-2); color: var(--color-accent-purple); border-color: var(--color-border); }
        #priorityFilterButton:hover:not(:disabled) { background-color: var(--color-border-medium); color: color-mix(in srgb, var(--color-accent-purple), #fff 20%);}
        #priorityFilterButton.active { background-color: var(--color-accent-purple); color: var(--color-background); border-color: var(--color-accent-purple); box-shadow: 0 0 8px 0px rgba(160, 112, 240, 0.5); }


        .filter-button {
            background-color: var(--color-surface-2);
            width: var(--filter-button-size);
            height: var(--filter-button-size);
            font-size: calc(var(--filter-button-size) * 0.4);
            font-weight: 600;
            min-width: 30px;
            min-height: 30px;
            padding: 0 2px;
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
        }
        .filter-button:hover:not(:disabled) {
            background-color: var(--color-border-medium);
            color: var(--color-text-primary);
        }
        .filter-button.active {
            background-color: var(--color-accent-blue);
            border-color: var(--color-accent-blue);
            color: var(--color-background);
            box-shadow: var(--shadow-glow-blue);
        }

        #championGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--gap-half);
            overflow-y: auto;
            align-content: flex-start;
            flex-grow: 1;
            min-height: 0;
            transition: opacity 0.3s ease;
            padding: var(--gap-size);
            background-color: var(--color-surface-1);
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
        }
        #championGrid::-webkit-scrollbar { width: 6px; }
        #championGrid::-webkit-scrollbar-track { background: transparent; }
        #championGrid::-webkit-scrollbar-thumb { background-color: var(--color-border); border-radius: 3px; }
        #championGrid::-webkit-scrollbar-thumb:hover { background-color: var(--color-border-medium); }
        #championGrid { scrollbar-width: thin; scrollbar-color: var(--color-border) transparent; }

        .champion-card {
            width: var(--card-size);
            height: var(--card-size);
            min-width: var(--card-min-size);
            min-height: var(--card-min-size);
            border-radius: 0.25rem;
            overflow: hidden;
            background-color: var(--color-surface-2);
            cursor: pointer;
            transition: transform 0.15s ease-in-out, box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative;
            flex-shrink: 0;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }
        .champion-card img { width: 100%; height: 100%; object-fit: cover; display: block; transition: filter 0.2s ease, transform 0.2s ease; }
        .champion-card:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
            border-color: var(--color-border-medium);
        }
         .champion-card:hover img {
             transform: scale(1.03);
         }
        .champion-card:focus-visible {
             outline: 2px solid var(--color-accent-blue);
             outline-offset: 1px;
             box-shadow: var(--shadow-glow-blue);
             border-color: var(--color-accent-blue);
             transform: scale(1.03);
        }

        .champion-card.selected { border-color: var(--color-accent-gold); }
        .champion-card.selected img { filter: grayscale(80%) brightness(50%) sepia(30%); opacity: 0.7; }
        .champion-card.disabled { pointer-events: none; opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .champion-card.disabled img { filter: grayscale(100%) brightness(40%); transform: none; }
        .champion-card.disabled:hover { transform: none; border-color: var(--color-border); }


        .tooltip {
            position: fixed;
            background-color: var(--color-tooltip-bg);
            color: var(--color-tooltip-text);
            padding: 0.5rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border-medium);
        }
        .tooltip.visible { opacity: 1; }
        .tooltip-title { font-weight: 600; display: block; margin-bottom: 0.1rem; color: var(--color-accent-gold); }
        .tooltip-name { font-weight: 400; color: var(--color-text-secondary); font-size: 0.8rem; }


        #statusMessage {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-surface-1);
            color: var(--color-text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            z-index: 90;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid var(--color-border-medium);
            box-shadow: var(--shadow-md);
            transform: translate(-50%, 10px);
        }
        #statusMessage.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1280px) {
             .search-controls-wrapper { flex-wrap: wrap; }
             #championSearch { min-width: 180px; }
        }

        @media (max-width: 1024px) {
            :root {
                --card-size: 7.5vh;
                --ban-size: 5vh;
                --button-size: 4vh;
                --filter-button-size: 3.5vh;
                --score-size: 4vh;
                --nick-font-size: 2.5vh;
                --gap-size: 0.3rem;
                --team-col-min-width: 220px;
            }
             .team-name { font-size: clamp(1rem, 3vmin, 1.4rem); max-width: 200px;}
             .search-controls-wrapper { margin-bottom: var(--gap-size); padding: var(--gap-half); }
             #championSearch { min-width: 150px; }
        }

        @media (max-width: 768px) {
             :root {
                --card-size: 7vh;
                --ban-size: 4.5vh;
                --button-size: 3.8vh;
                --filter-button-size: 3.2vh;
                --score-size: 3.8vh;
                --nick-font-size: 2.2vh;
                --team-col-min-width: 180px;
             }
            #mainLayout {
                grid-template-columns: auto minmax(150px, 1fr) auto;
                gap: var(--gap-half);
            }
             .center-controls-wrapper {
                grid-template-columns: 1fr auto auto auto 1fr;
                gap: var(--gap-half);
            }
            .team-name { max-width: 150px; font-size: clamp(0.9rem, 2.8vmin, 1.2rem);}
            .bans-container { gap: 2px; }
            .search-controls-wrapper { flex-direction: row; flex-wrap: wrap; align-items: center; }
            #championSearch { width: auto; flex-grow: 1; min-width: 120px; }
            #roleFilterButtons { justify-content: flex-start; }
            .picks-container { gap: 2px; }
        }

        @media (max-width: 480px) {
            body { padding: 2px; }
             #app-container { padding: 2px; } /* Reduce padding on small screens */
            :root {
                --card-size: 6.5vh;
                --ban-size: 4vh;
                --button-size: 3.5vh;
                --filter-button-size: 3vh;
                --score-size: 3.5vh;
                --nick-font-size: 2vh;
                --card-min-size: 38px;
                --ban-min-size: 25px;
                --button-min-size: 28px;
                --score-min-size: 28px;
                --team-col-min-width: 90px;
            }
             #mainLayout {
                grid-template-columns: auto minmax(100px, 1fr) auto;
                gap: 2px;
            }
             #topRowContainer { grid-template-columns: 1fr auto 1fr; }
             .top-row-cell.blue-info { grid-column: 1; }
             .top-row-cell.center-controls { grid-column: 2; }
             .top-row-cell.red-info { grid-column: 3; }
             .center-controls-wrapper { display: flex; flex-wrap: wrap; justify-content: center; }
             #timerDisplay { order: -1; margin-bottom: var(--gap-half); }
             .team-name { max-width: 100px; font-size: clamp(0.8rem, 2.5vmin, 1rem); }
             .bans-container { display: grid; grid-template-columns: repeat(3, 1fr); }
             #blue-ban-4, #blue-ban-5, #red-ban-4, #red-ban-5 { margin-top: 2px; }
             .filter-button { min-width: 28px; min-height: 28px; font-size: 0.6rem; }
             #championGrid { gap: 2px; }
             .team-column { padding: var(--gap-half); }
             .picks-container { gap: 1px; }
             .nickname-input { min-height: 16px; font-size: 1.8vh; }
             .search-controls-wrapper { overflow-x: visible; flex-wrap: wrap; }
             #championSearch { min-width: 100px; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <button id="adminButton" class="hidden">–ê–¥–º–∏–Ω</button>

    <div id="homePage" class="page">
      <h1 id="homeTitle" class="text-3xl sm:text-4xl md:text-5xl font-bold mb-8 text-center">
        LoL and Wild Rift Drafter
      </h1>
      <input type="text" id="team1NameInput" class="lobby-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ö–æ–º–∞–Ω–¥—ã 1 (–°–∏–Ω–∏–µ)">
      <input type="text" id="team2NameInput" class="lobby-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ö–æ–º–∞–Ω–¥—ã 2 (–ö—Ä–∞—Å–Ω—ã–µ)">
      <button id="createLobbyButton">–°–æ–∑–¥–∞—Ç—å –õ–æ–±–±–∏</button>
      <div id="lobbyLinksDisplay" class="hidden">
          <p><strong>–°—É–¥—å—è:</strong> <span id="judgeLinkText"></span> <button class="copy-button" data-link-id="judgeLinkText">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></p>
          <p><strong>–ö–æ–º–∞–Ω–¥–∞ 1 (–°–∏–Ω–∏–µ):</strong> <span id="team1LinkText"></span> <button class="copy-button" data-link-id="team1LinkText">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></p>
          <p><strong>–ö–æ–º–∞–Ω–¥–∞ 2 (–ö—Ä–∞—Å–Ω—ã–µ):</strong> <span id="team2LinkText"></span> <button class="copy-button" data-link-id="team2LinkText">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></p>
      </div>
    </div>

    <div id="draftPage" class="page hidden">
        <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
            <div class="text-white text-xl font-semibold animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤...</div>
        </div>

        <div id="mainLayout" class="hidden">
            <div id="topRowContainer">
                <div class="top-row-cell blue-info">
                    <div class="bans-container" id="blue-bans-display">
                        <div id="blue-ban-1" class="ban-slot" aria-label="–°–∏–Ω–∏–π –±–∞–Ω 1"></div>
                        <div id="blue-ban-2" class="ban-slot" aria-label="–°–∏–Ω–∏–π –±–∞–Ω 2"></div>
                        <div id="blue-ban-3" class="ban-slot" aria-label="–°–∏–Ω–∏–π –±–∞–Ω 3"></div>
                        <div id="blue-ban-4" class="ban-slot" aria-label="–°–∏–Ω–∏–π –±–∞–Ω 4"></div>
                        <div id="blue-ban-5" class="ban-slot" aria-label="–°–∏–Ω–∏–π –±–∞–Ω 5"></div>
                    </div>
                </div>

                <div class="top-row-cell center-controls">
                     <div class="center-controls-wrapper">
                         <h2 contenteditable="false" spellcheck="false" class="team-name" id="blue-team-name-h2" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã">–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞</h2>
                         <div contenteditable="false" id="blue-score" class="score-input" inputmode="numeric" aria-label="–°—á–µ—Ç —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã"></div>
                         <button id="timerDisplay" class="timer-display-button" title="–ù–∞—á–∞—Ç—å –¥—Ä–∞—Ñ—Ç" aria-label="–¢–∞–π–º–µ—Ä / –°—Ç–∞—Ä—Ç –¥—Ä–∞—Ñ—Ç–∞">--:--</button>
                         <div contenteditable="false" id="red-score" class="score-input" inputmode="numeric" aria-label="–°—á–µ—Ç –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã"></div>
                         <h2 contenteditable="false" spellcheck="false" class="team-name" id="red-team-name-h2" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã">–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞</h2>
                     </div>
                </div>

                <div class="top-row-cell red-info">
                     <div class="bans-container" id="red-bans-display">
                        <div id="red-ban-1" class="ban-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω 1"></div>
                        <div id="red-ban-2" class="ban-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω 2"></div>
                        <div id="red-ban-3" class="ban-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω 3"></div>
                        <div id="red-ban-4" class="ban-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω 4"></div>
                        <div id="red-ban-5" class="ban-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω 5"></div>
                     </div>
                </div>
            </div>

            <div id="draftArea">
                <div class="team-column blue-column draft-disabled">
                     <div class="picks-container blue-picks-container">
                         <div id="blue-pick-1" class="pick-slot" aria-label="–°–∏–Ω–∏–π –ø–∏–∫ 1"></div>
                         <div id="blue-pick-2" class="pick-slot" aria-label="–°–∏–Ω–∏–π –ø–∏–∫ 2"></div>
                         <div id="blue-pick-3" class="pick-slot" aria-label="–°–∏–Ω–∏–π –ø–∏–∫ 3"></div>
                         <div id="blue-pick-4" class="pick-slot" aria-label="–°–∏–Ω–∏–π –ø–∏–∫ 4"></div>
                         <div id="blue-pick-5" class="pick-slot" aria-label="–°–∏–Ω–∏–π –ø–∏–∫ 5"></div>
                     </div>
                </div>

                <div id="championGridContainer">
                     <div id="globallyBannedDisplay" class="hidden">
                         <div class="global-bans-row">
                             <div id="global-bans-blue"></div>
                             <div id="global-bans-red"></div>
                         </div>
                     </div>
                     <div class="search-controls-wrapper">
                         <input type="text" id="championSearch" placeholder="–ü–æ–∏—Å–∫..." aria-label="–ü–æ–∏—Å–∫ —á–µ–º–ø–∏–æ–Ω–∞" class="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500">
                         <button id="confirmPickBanButton" class="action-button confirm-button icon-button" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä/–±–∞–Ω" aria-label="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä/–±–∞–Ω" disabled>‚úîÔ∏è</button>
                         <div id="roleFilterButtons" class="flex justify-center gap-2" role="group" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª—è–º">
                             <button type="button" class="action-button filter-button active" data-role="All" title="–§–∏–ª—å—Ç—Ä: –í—Å–µ">–í–°–ï</button>
                             <button type="button" class="action-button filter-button" data-role="Top" title="–§–∏–ª—å—Ç—Ä: –¢–æ–ø">–¢–û–ü</button>
                             <button type="button" class="action-button filter-button" data-role="Jungle" title="–§–∏–ª—å—Ç—Ä: –õ–µ—Å">–õ–ï–°</button>
                             <button type="button" class="action-button filter-button" data-role="Mid" title="–§–∏–ª—å—Ç—Ä: –ú–∏–¥">–ú–ò–î</button>
                             <button type="button" class="action-button filter-button" data-role="ADC" title="–§–∏–ª—å—Ç—Ä: –ê–î–ö">–ê–î–ö</button>
                             <button type="button" class="action-button filter-button" data-role="Support" title="–§–∏–ª—å—Ç—Ä: –ü–æ–¥–¥–µ—Ä–∂–∫–∞">–°–ê–ü</button>
                         </div>
                         <button id="priorityFilterButton" class="action-button icon-button" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤">‚≠ê</button>
                         <button id="nextDraftButton" class="action-button next-draft-button icon-button" title="–°–ª–µ–¥—É—é—â–∏–π –¥—Ä–∞—Ñ—Ç (Fearless)" aria-label="–°–ª–µ–¥—É—é—â–∏–π –¥—Ä–∞—Ñ—Ç (Fearless)" disabled>‚ñ∂Ô∏è</button>
                         <button id="swapButton" class="action-button icon-button" title="–ü–æ–º–µ–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –º–µ—Å—Ç–∞–º–∏" aria-label="–ü–æ–º–µ–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –º–µ—Å—Ç–∞–º–∏">‚áÑ</button>
                         <button id="clearPicksButton" class="action-button icon-button" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–∏–∫–∏/–±–∞–Ω—ã —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã (–≤–∫–ª. –≥–ª–æ–±.)" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –ø–∏–∫–∏/–±–∞–Ω—ã —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã">üßπ</button>
                         <button id="toggleTimerButton" class="action-button icon-button" title="–°–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —Ç–∞–π–º–µ—Ä–∞ (30/45—Å)" aria-label="–°–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —Ç–∞–π–º–µ—Ä–∞">‚è±Ô∏è</button>
                         <button id="undoButton" class="action-button undo-button icon-button" title="–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ" disabled>‚Ü©</button>
                         <button id="resetButton" class="action-button reset-button icon-button" title="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å" aria-label="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å">üîÑ</button>
                         <button id="returnHomeButton" class="action-button icon-button" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é" aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é">üè†</button>
                     </div>
                     <div id="championGrid" role="grid" aria-label="–°–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–µ–º–ø–∏–æ–Ω–æ–≤">
                         </div>
                </div>

                <div class="team-column red-column draft-disabled">
                    <div class="picks-container red-picks-container">
                         <div id="red-pick-1" class="pick-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –ø–∏–∫ 1"></div>
                         <div id="red-pick-2" class="pick-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –ø–∏–∫ 2"></div>
                         <div id="red-pick-3" class="pick-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –ø–∏–∫ 3"></div>
                         <div id="red-pick-4" class="pick-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –ø–∏–∫ 4"></div>
                         <div id="red-pick-5" class="pick-slot" aria-label="–ö—Ä–∞—Å–Ω—ã–π –ø–∏–∫ 5"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="championTooltip" class="tooltip" role="tooltip"></div>
        <div id="statusMessage" aria-live="polite"></div>
    </div>
</div>

<script defer>
    // script.js v6.0 - Final Version
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Fully Loaded. Initializing App v6.0..."); // Version Updated

        // --- Page Elements ---
        const appContainer = document.getElementById('app-container');
        const homePage = document.getElementById('homePage');
        const draftPage = document.getElementById('draftPage');
        const adminButton = document.getElementById('adminButton');
        // Home Page Elements
        const team1NameInput = document.getElementById('team1NameInput');
        const team2NameInput = document.getElementById('team2NameInput');
        const createLobbyButton = document.getElementById('createLobbyButton');
        const lobbyLinksDisplay = document.getElementById('lobbyLinksDisplay');
        const judgeLinkText = document.getElementById('judgeLinkText');
        const team1LinkText = document.getElementById('team1LinkText');
        const team2LinkText = document.getElementById('team2LinkText');

        // --- Draft Simulator Global Elements ---
        let loadingIndicator, mainLayout, championGridElement, startButton, resetButton, undoButton, timerDisplay, championSearch, bluePicksContainer, redPicksContainer, blueColumn, redColumn, swapButton, clearPicksButton, toggleTimerButton, filterButtons, confirmPickBanButton, priorityFilterButton, nextDraftButton, globallyBannedDisplay, globalBansBlueContainer, globalBansRedContainer, championTooltip, statusMessage, blueTeamNameH2, redTeamNameH2, blueScoreEl, redScoreEl, returnHomeButton;

        // --- State Variables ---
        let currentPage = 'home';
        let isDraftInitialized = false;
        let currentUserRole = null;
        let userTeamSide = null;

        // Draft specific state variables
        let allChampionsData = { en: null, ru: null };
        let processedChampions = [];
        let ddragonVersion = 'latest';
        let baseIconUrl = '';
        let baseSplashUrl = '';
        let currentStep = 0;
        let selectedChampions = new Set();
        let draftHistory = [];
        let pickNicknames = {};
        let isDraftComplete = false;
        let isDraftStarted = false;
        let selectedSwapSlotId = null;
        let timerInterval = null;
        let draftTimerDuration = 30;
        let timerSeconds = draftTimerDuration;
        let currentRoleFilter = 'All';
        let previewedChampion = null;
        let isPriorityFilterActive = false;
        let statusTimeout = null;
        let globallyDisabledChampions = new Set();
        let globalBanHistory = [];

        // --- Permissions Map ---
        const permissions = {
            admin: {
                editTeamName: true, editScore: true, clearDraft: true, resetDraft: true, startDraft: true, toggleTimerDuration: true, swapSides: true, editNicknames: true, togglePriorityFilter: true, nextDraft: true,
                pickChampion: true, banChampion: true, undoAction: true, confirmAction: true, useRoleFilters: true, returnHome: true
            },
            judge: {
                editTeamName: true, editScore: true, clearDraft: true, resetDraft: true, startDraft: true, toggleTimerDuration: true, swapSides: true, editNicknames: true, togglePriorityFilter: true, nextDraft: true,
                pickChampion: false, banChampion: false, undoAction: false, confirmAction: false, useRoleFilters: false, returnHome: true
            },
            team1: {
                editTeamName: false, editScore: false, clearDraft: false, resetDraft: false, startDraft: false, toggleTimerDuration: false, swapSides: false, editNicknames: false, togglePriorityFilter: false, nextDraft: false,
                pickChampion: true, banChampion: true, undoAction: true, confirmAction: true, useRoleFilters: true, returnHome: true
            },
            team2: {
                editTeamName: false, editScore: false, clearDraft: false, resetDraft: false, startDraft: false, toggleTimerDuration: false, swapSides: false, editNicknames: false, togglePriorityFilter: false, nextDraft: false,
                pickChampion: true, banChampion: true, undoAction: true, confirmAction: true, useRoleFilters: true, returnHome: true
            },
             default: {
                 editTeamName: false, editScore: false, clearDraft: false, resetDraft: false, startDraft: false, toggleTimerDuration: false, swapSides: false, editNicknames: false, togglePriorityFilter: false, nextDraft: false,
                 pickChampion: false, banChampion: false, undoAction: false, confirmAction: false, useRoleFilters: false, returnHome: true
             }
        };

        // --- Helper Functions ---
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };
        const showStatusMessage = (message, duration = 3000) => { if (!statusMessage) statusMessage = document.getElementById('statusMessage'); if (!statusMessage) { console.warn("Status message element not found!"); return; } statusMessage.textContent = message; statusMessage.classList.add('visible'); clearTimeout(statusTimeout); statusTimeout = setTimeout(() => { statusMessage.classList.remove('visible'); }, duration); };
        const getChampionById = (id) => processedChampions.find(champ => champ.id === id);

        // Permission Check Function
        function hasPermission(action, team = null) {
            const rolePerms = permissions[currentUserRole] || permissions.default;
            const isAdmin = currentUserRole === 'admin';
            const hasBasicPermission = isAdmin || rolePerms[action];

            let result = false;
            if (!hasBasicPermission) {
                result = false; // No basic permission
            } else if (isAdmin) {
                result = true; // Admin has all permissions
            } else if ((currentUserRole === 'team1' || currentUserRole === 'team2') && team) {
                result = userTeamSide === team; // Team can only act on their side
            } else {
                result = true; // Judge or non-team-specific action allowed
            }
            // console.log(`DEBUG: hasPermission(action: ${action}, team: ${team}, role: ${currentUserRole}, side: ${userTeamSide}) -> ${result}`);
            return result;
        }

         // Function to copy text to clipboard
         async function copyToClipboard(text) {
             if (!navigator.clipboard) {
                 try {
                     const textArea = document.createElement("textarea");
                     textArea.value = text;
                     textArea.style.position = "fixed"; document.body.appendChild(textArea);
                     textArea.focus(); textArea.select(); document.execCommand('copy');
                     document.body.removeChild(textArea);
                     showStatusMessage("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (fallback)", 1500);
                 } catch (err) { console.error('Fallback copy failed:', err); showStatusMessage("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", 2000); }
                 return;
             }
             try {
                 await navigator.clipboard.writeText(text);
                 showStatusMessage("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!", 1500);
             } catch (err) { console.error('Async clipboard copy failed:', err); showStatusMessage("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", 2000); }
         }


        // --- Navigation & Role Handling ---
        function navigateTo(pageName) {
            console.log(`Navigating to: ${pageName}`);
            currentPage = pageName;

            if(homePage) homePage.classList.add('hidden');
            if(draftPage) draftPage.classList.add('hidden');
            if(adminButton) adminButton.classList.add('hidden');

            if (pageName === 'home') {
                if(homePage) homePage.classList.remove('hidden');
                if(adminButton) adminButton.classList.remove('hidden');
                if (window.location.hash && currentUserRole !== 'admin') {
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            } else if (pageName === 'draft') {
                if(draftPage) draftPage.classList.remove('hidden');
                if (!isDraftInitialized) {
                    console.log("Initializing draft simulator for the first time...");
                    initializeAppDraft();
                    isDraftInitialized = true;
                } else {
                     console.log("Draft already initialized, re-applying permissions for role:", currentUserRole);
                     // Ensure elements are available before applying permissions again
                     if (checkDraftElements()) {
                        applyRolePermissions(currentUserRole);
                        if(blueTeamNameH2) blueTeamNameH2.textContent = localStorage.getItem('lobbyTeam1Name') || '–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞';
                        if(redTeamNameH2) redTeamNameH2.textContent = localStorage.getItem('lobbyTeam2Name') || '–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞';
                        updateDraftUI(); // Update UI based on potentially new role
                     } else {
                         console.error("Draft elements not found when trying to re-apply permissions.");
                         showStatusMessage("–û—à–∏–±–∫–∞ UI: –≠–ª–µ–º–µ–Ω—Ç—ã –¥—Ä–∞—Ñ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", 5000);
                     }
                }
            }
        }

        function getRoleFromHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#role=')) {
                const role = hash.substring(6);
                if (permissions[role] && role !== 'admin') {
                    return role;
                }
            }
            return null;
        }

        // --- Home Page Logic ---
        function handleCreateLobby() {
            console.log("handleCreateLobby called");
            const team1Name = team1NameInput.value.trim() || "–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞";
            const team2Name = team2NameInput.value.trim() || "–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞";
            localStorage.setItem('lobbyTeam1Name', team1Name);
            localStorage.setItem('lobbyTeam2Name', team2Name);
            const baseUrl = window.location.origin + window.location.pathname;
            const judgeLink = baseUrl + '#role=judge';
            const team1Link = baseUrl + '#role=team1';
            const team2Link = baseUrl + '#role=team2';
            if (judgeLinkText) judgeLinkText.textContent = judgeLink;
            if (team1LinkText) team1LinkText.textContent = team1Link;
            if (team2LinkText) team2LinkText.textContent = team2Link;
            if (lobbyLinksDisplay) lobbyLinksDisplay.classList.remove('hidden');
            showStatusMessage("–õ–æ–±–±–∏ —Å–æ–∑–¥–∞–Ω–æ! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫–∏.", 3000);
        }

        // --- Admin Button Logic ---
        function handleAdminClick() {
            console.log("Admin button clicked.");
            currentUserRole = 'admin';
            userTeamSide = null;
            const team1Name = team1NameInput.value.trim() || "–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞";
            const team2Name = team2NameInput.value.trim() || "–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞";
            localStorage.setItem('lobbyTeam1Name', team1Name);
            localStorage.setItem('lobbyTeam2Name', team2Name);
            navigateTo('draft');
        }

        // Add listener for create lobby button
        if (createLobbyButton) {
            createLobbyButton.addEventListener('click', handleCreateLobby);
        } else { console.warn("Create Lobby Button not found"); }

         // Add listeners for copy buttons
         document.querySelectorAll('.copy-button').forEach(button => {
             button.addEventListener('click', (event) => {
                 const linkId = event.target.dataset.linkId;
                 const linkSpan = document.getElementById(linkId);
                 if (linkSpan) {
                     copyToClipboard(linkSpan.textContent);
                 } else { console.warn("Copy link span not found for id:", linkId); }
             });
         });

        // Add listener for Admin button
        if (adminButton) {
            adminButton.addEventListener('click', handleAdminClick);
        } else { console.warn("Admin Button not found"); }

        // --- Function to check if draft elements exist ---
        function checkDraftElements() {
            const elementsToCheck = [
                loadingIndicator, mainLayout, championGridElement, timerDisplay, resetButton, undoButton,
                championSearch, blueColumn, redColumn, swapButton, clearPicksButton, toggleTimerButton,
                confirmPickBanButton, priorityFilterButton, nextDraftButton, returnHomeButton,
                blueTeamNameH2, redTeamNameH2, blueScoreEl, redScoreEl, statusMessage
            ];
            const missingElements = elementsToCheck.filter(el => !el);
            if (missingElements.length > 0) {
                console.error("Missing draft elements:", missingElements.map(el => el?.id || 'unknown'));
                return false;
            }
            return true;
        }


        // --- Draft Simulator Logic (all inside initializeAppDraft) ---
        async function initializeAppDraft() {
            console.log("initializeAppDraft started");
            try {

                // 1. Determine Role
                if (!currentUserRole) {
                    currentUserRole = getRoleFromHash();
                    if (!currentUserRole) {
                        console.error("No role determined. Navigating home.");
                        navigateTo('home');
                        return;
                    }
                }
                console.log(`Initializing draft with Role: ${currentUserRole}`);

                // Assign team side
                if (currentUserRole === 'team1') userTeamSide = 'blue';
                else if (currentUserRole === 'team2') userTeamSide = 'red';
                else userTeamSide = null;

                // 2. Get Draft Page Elements
                loadingIndicator = document.getElementById('loadingIndicator');
                mainLayout = document.getElementById('mainLayout');
                championGridElement = document.getElementById('championGrid');
                startButton = document.getElementById('timerDisplay');
                resetButton = document.getElementById('resetButton');
                undoButton = document.getElementById('undoButton');
                timerDisplay = document.getElementById('timerDisplay');
                championSearch = document.getElementById('championSearch');
                bluePicksContainer = document.querySelector('.blue-picks-container');
                redPicksContainer = document.querySelector('.red-picks-container');
                blueColumn = document.querySelector('.blue-column');
                redColumn = document.querySelector('.red-column');
                swapButton = document.getElementById('swapButton');
                clearPicksButton = document.getElementById('clearPicksButton');
                toggleTimerButton = document.getElementById('toggleTimerButton');
                filterButtons = document.querySelectorAll('#roleFilterButtons .filter-button');
                confirmPickBanButton = document.getElementById('confirmPickBanButton');
                priorityFilterButton = document.getElementById('priorityFilterButton');
                nextDraftButton = document.getElementById('nextDraftButton');
                globallyBannedDisplay = document.getElementById('globallyBannedDisplay');
                globalBansBlueContainer = document.getElementById('global-bans-blue');
                globalBansRedContainer = document.getElementById('global-bans-red');
                championTooltip = document.getElementById('championTooltip');
                statusMessage = document.getElementById('statusMessage');
                blueTeamNameH2 = document.getElementById('blue-team-name-h2');
                redTeamNameH2 = document.getElementById('red-team-name-h2');
                blueScoreEl = document.getElementById('blue-score');
                redScoreEl = document.getElementById('red-score');
                returnHomeButton = document.getElementById('returnHomeButton');

                // 2.1 Check if elements were found
                if (!checkDraftElements()) {
                    throw new Error("One or more draft page elements were not found during initialization!");
                }
                console.log("All draft elements found.");

                // 3. Load Data
                if(loadingIndicator) loadingIndicator.classList.remove('hidden');
                const dataLoaded = await loadChampionData();
                if (!dataLoaded) {
                    throw new Error("Failed to load champion data.");
                }
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
                if(mainLayout) mainLayout.classList.remove('hidden');

                // 4. Initial Setup based on Role
                displayChampions();
                resetDraftFull(true); // Initial reset, applies permissions internally

                // Set initial team names
                if(blueTeamNameH2 && localStorage.getItem('lobbyTeam1Name')) blueTeamNameH2.textContent = localStorage.getItem('lobbyTeam1Name');
                if(redTeamNameH2 && localStorage.getItem('lobbyTeam2Name')) redTeamNameH2.textContent = localStorage.getItem('lobbyTeam2Name');

                // 5. Attach Event Listeners
                console.log("Attaching event listeners...");
                if (timerDisplay) timerDisplay.addEventListener('click', handleStartDraft); else console.warn("Listener not attached: timerDisplay not found");
                if (resetButton) resetButton.addEventListener('click', () => { console.log("Reset button clicked"); resetDraftFull(false); }); else console.warn("Listener not attached: resetButton not found");
                if (clearPicksButton) clearPicksButton.addEventListener('click', () => { console.log("Clear Picks button clicked"); resetCurrentGamePicksBans(false, false); }); else console.warn("Listener not attached: clearPicksButton not found");
                if (undoButton) undoButton.addEventListener('click', handleUndo); else console.warn("Listener not attached: undoButton not found");
                if (swapButton) swapButton.addEventListener('click', handleSwapTeams); else console.warn("Listener not attached: swapButton not found");
                if (toggleTimerButton) toggleTimerButton.addEventListener('click', handleToggleTimer); else console.warn("Listener not attached: toggleTimerButton not found");
                if (confirmPickBanButton) confirmPickBanButton.addEventListener('click', handleConfirmPickBan); else console.warn("Listener not attached: confirmPickBanButton not found");
                if (priorityFilterButton) priorityFilterButton.addEventListener('click', handlePriorityFilterToggle); else console.warn("Listener not attached: priorityFilterButton not found");
                if (nextDraftButton) nextDraftButton.addEventListener('click', handleNextDraft); else console.warn("Listener not attached: nextDraftButton not found");
                if (championSearch) championSearch.addEventListener('input', debouncedFilter); else console.warn("Listener not attached: championSearch not found");
                if (filterButtons) filterButtons.forEach(button => { if (button) button.addEventListener('click', handleRoleFilterClick); else console.warn("Listener not attached: a filter button was null"); }); else console.warn("Listener not attached: filterButtons collection is null/empty");
                if (blueColumn) blueColumn.addEventListener('click', handlePickContainerClick); else console.warn("Listener not attached: blueColumn not found");
                if (redColumn) redColumn.addEventListener('click', handlePickContainerClick); else console.warn("Listener not attached: redColumn not found");
                if (returnHomeButton) returnHomeButton.addEventListener('click', () => { console.log("Return Home button clicked"); navigateTo('home'); }); else console.warn("Listener not attached: returnHomeButton not found");

                // Add listeners for editable fields
                [blueTeamNameH2, redTeamNameH2, blueScoreEl, redScoreEl].forEach(el => {
                    if (el) {
                        el.addEventListener('blur', (e) => {
                            const permissionNeeded = el.id.includes('name') ? 'editTeamName' : 'editScore';
                            if (!hasPermission(permissionNeeded)) return;
                            e.target.textContent = e.target.textContent.trim();
                        });
                        el.addEventListener('keydown', (e) => {
                            const permissionNeeded = el.id.includes('name') ? 'editTeamName' : 'editScore';
                            if (!hasPermission(permissionNeeded)) return;
                            if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
                        });
                    } else { console.warn("Listener not attached: An editable H2/Score element was not found"); }
                });
                console.log("Event listeners attached.");

                console.log("Draft simulator page initialized successfully for role:", currentUserRole);

            } catch (error) {
                console.error("Error during initializeAppDraft:", error);
                showStatusMessage(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 10000);
                if(loadingIndicator) loadingIndicator.textContent = `–û—à–∏–±–∫–∞! ${error.message}`;
                if(mainLayout) mainLayout.classList.add('hidden');
            }

        } // --- End of initializeAppDraft ---


        // --- Role Permission Application ---
        function applyRolePermissions(role) {
            console.log(`DEBUG: Applying permissions for role: ${role}`);
            const can = (action, team = null) => hasPermission(action, team);

            // Enable/Disable Buttons
            if(timerDisplay) timerDisplay.disabled = !can('startDraft');
            if(resetButton) resetButton.disabled = !can('resetDraft');
            if(clearPicksButton) clearPicksButton.disabled = !can('clearDraft');
            if(undoButton) undoButton.disabled = !can('undoAction'); // State checked later
            if(swapButton) swapButton.disabled = !can('swapSides'); // State checked later
            if(toggleTimerButton) toggleTimerButton.disabled = !can('toggleTimerDuration'); // State checked later
            if(confirmPickBanButton) confirmPickBanButton.disabled = !can('confirmAction'); // State checked later
            if(priorityFilterButton) priorityFilterButton.disabled = !can('togglePriorityFilter');
            if(nextDraftButton) nextDraftButton.disabled = !can('nextDraft'); // State checked later
            if(returnHomeButton) returnHomeButton.disabled = !can('returnHome');

            // Enable/Disable Filters
            if(filterButtons) filterButtons.forEach(btn => { if(btn) btn.disabled = !can('useRoleFilters'); });

            // Enable/Disable Editing
            if(blueTeamNameH2) blueTeamNameH2.contentEditable = can('editTeamName');
            if(redTeamNameH2) redTeamNameH2.contentEditable = can('editTeamName');
            if(blueScoreEl) blueScoreEl.contentEditable = can('editScore');
            if(redScoreEl) redScoreEl.contentEditable = can('editScore');

            // Disable Champion Grid/Slots based on role
            if (championGridElement) championGridElement.style.pointerEvents = (role === 'judge') ? 'none' : 'auto';
            if (blueColumn) blueColumn.classList.toggle('role-disabled', role === 'team2');
            if (redColumn) redColumn.classList.toggle('role-disabled', role === 'team1');
            if (role === 'admin') {
                if(blueColumn) blueColumn.classList.remove('role-disabled');
                if(redColumn) redColumn.classList.remove('role-disabled');
            }

             updateNicknameEditability();
             console.log(`DEBUG: Permissions applied for role: ${role}`);
        }

         // --- Update Nickname Editability based on Role ---
         function updateNicknameEditability() {
             const canEdit = hasPermission('editNicknames');
             document.querySelectorAll('.nickname-input').forEach(input => {
                 input.contentEditable = canEdit;
                 input.style.cursor = canEdit ? 'text' : 'default';
             });
         }


        // --- Data Fetching (Draft Specific) ---
        async function loadChampionData() {
             try {
                 console.log("Fetching DDragon versions...");
                 const versionsResponse = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
                 if (!versionsResponse.ok) throw new Error(`–í–µ—Ä—Å–∏–∏: ${versionsResponse.statusText}`);
                 const versions = await versionsResponse.json();
                 ddragonVersion = versions[0];
                 console.log(`Using DDragon version: ${ddragonVersion}`);
                 baseIconUrl = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/img/champion/`;
                 baseSplashUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/splash/`;

                 const championRolesMap = { /* Placeholder */ };
                 const priorityChampions = new Set([ /* Placeholder */ ]);

                 const dataUrlEn = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/data/en_US/champion.json`;
                 const dataUrlRu = `https://ddragon.leagueoflegends.com/cdn/${ddragonVersion}/data/ru_RU/champion.json`;
                 console.log("Fetching champion data (EN & RU)...");

                 const [enResponse, ruResponse] = await Promise.all([
                     fetch(dataUrlEn),
                     fetch(dataUrlRu)
                 ]);

                 if (!enResponse.ok) throw new Error(`–î–∞–Ω–Ω—ã–µ EN: ${enResponse.statusText}`);
                 allChampionsData.en = (await enResponse.json()).data;
                 console.log("EN data fetched.");

                 if (!ruResponse.ok) {
                     console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ RU: ${ruResponse.statusText}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞.`);
                     allChampionsData.ru = null;
                 } else {
                     allChampionsData.ru = (await ruResponse.json()).data;
                     console.log("RU data fetched.");
                 }

                 processedChampions = Object.keys(allChampionsData.en).map(champId => {
                    const enData = allChampionsData.en[champId];
                    const ruData = allChampionsData.ru ? allChampionsData.ru[champId] : null;
                    return {
                        id: enData.id,
                        name: { en: enData.name, ru: ruData ? ruData.name : enData.name },
                        title: { en: enData.title, ru: ruData ? ruData.title : enData.title },
                        roles: championRolesMap[enData.id] || [],
                        iconUrl: `${baseIconUrl}${enData.image.full}`,
                        splashUrl: `${baseSplashUrl}${enData.id}_0.jpg`
                    };
                 });

                 processedChampions.sort((a, b) => a.name.ru.localeCompare(b.name.ru, 'ru'));
                 console.log(`Successfully loaded and processed ${processedChampions.length} champions.`);
                 return true;

             } catch (error) {
                 console.error("Error loading champion data:", error);
                 showStatusMessage(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤: ${error.message}`, 5000);
                 if(loadingIndicator) loadingIndicator.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! ${error.message}`;
                 if(mainLayout) mainLayout.classList.add('hidden');
                 return false;
             }
         }


        // --- Timer Functions (Draft Specific) ---
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; if(timerDisplay) timerDisplay.classList.remove('timer-running', 'timer-ending'); }
        function formatTime(seconds) { const minutes = Math.floor(seconds / 60); const remainingSeconds = seconds % 60; return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; }
        function resetTimerDisplay() { stopTimer(); timerSeconds = draftTimerDuration; if(timerDisplay) { timerDisplay.textContent = formatTime(timerSeconds); timerDisplay.disabled = !hasPermission('startDraft'); timerDisplay.classList.remove('timer-disabled'); timerDisplay.title = '–ù–∞—á–∞—Ç—å –¥—Ä–∞—Ñ—Ç'; timerDisplay.setAttribute('aria-label', '–¢–∞–π–º–µ—Ä / –°—Ç–∞—Ä—Ç –¥—Ä–∞—Ñ—Ç–∞'); } }
        function startTimer() {
            console.log("startTimer called");
            if (!hasPermission('startDraft')) { console.log("startTimer: No permission"); return; }
            stopTimer();
            timerSeconds = draftTimerDuration;
            if (!timerDisplay) { console.warn("startTimer: timerDisplay not found"); return; }
            timerDisplay.textContent = formatTime(timerSeconds);
            timerDisplay.disabled = true;
            timerDisplay.classList.add('timer-running', 'timer-disabled');
            timerDisplay.title = '–î—Ä–∞—Ñ—Ç –∏–¥–µ—Ç...';
            timerDisplay.setAttribute('aria-label', `–¢–∞–π–º–µ—Ä: ${formatTime(timerSeconds)}`);
            timerInterval = setInterval(() => {
                timerSeconds--;
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(timerSeconds);
                    timerDisplay.setAttribute('aria-label', `–¢–∞–π–º–µ—Ä: ${formatTime(timerSeconds)}`);
                    if (timerSeconds <= 10 && timerSeconds > 0) {
                        timerDisplay.classList.add('timer-ending');
                    } else {
                        timerDisplay.classList.remove('timer-ending');
                    }
                }
                if (timerSeconds <= 0) {
                    stopTimer();
                    if(timerDisplay) timerDisplay.classList.add('timer-ending');
                    console.log("Timer reached zero!");
                    const draftOrder = getDraftOrder();
                    if (currentStep < draftOrder.length) {
                        const currentAction = draftOrder[currentStep];
                        // --- MODIFIED TIMER LOGIC ---
                        if (currentAction.type === 'pick') {
                            if (previewedChampion) {
                                // Auto-confirm if a champion was previewed
                                console.log("Timer ended during PICK phase. Auto-confirming:", previewedChampion.id);
                                showStatusMessage(`–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ê–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: ${previewedChampion.name.ru}`, 3000);
                                handleConfirmPickBan(); // Confirm the previewed champion
                            } else {
                                // Clear draft if no champion was previewed
                                console.log("Timer ended during PICK phase. No champion previewed. Clearing current game.");
                                showStatusMessage("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ü–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω. –î—Ä–∞—Ñ—Ç –æ—á–∏—â–µ–Ω.", 3000);
                                resetCurrentGamePicksBans(true, false); // Force clear, including global
                            }
                        } else if (currentAction.type === 'ban') {
                            // Keep original ban logic: skip ban
                            console.log("Timer ended during BAN phase. Skipping ban.");
                            showStatusMessage("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ë–∞–Ω –ø—Ä–æ–ø—É—â–µ–Ω.", 2000);
                            const slotElement = document.getElementById(currentAction.slot);
                            if (slotElement) {
                                restoreSlotPlaceholder(slotElement, currentAction.slot, '');
                            }
                            currentStep++;
                            resetTimerDisplay();
                            updateDraftUI();
                        }
                        // --- END MODIFIED TIMER LOGIC ---
                    } else {
                         console.log("Timer ended but draft already complete?");
                    }
                }
            }, 1000);
        }


        // --- Draft Logic Functions (Draft Specific - with permission checks added) ---
         function createChampionCard(champ) {
            const card = document.createElement('button');
            card.className = 'champion-card';
            card.dataset.championId = champ.id;
            card.dataset.championNameEn = champ.name.en.toLowerCase();
            card.dataset.championNameRu = champ.name.ru.toLowerCase();
            card.dataset.roles = champ.roles.join(',');
            card.setAttribute('role', 'gridcell');
            card.setAttribute('aria-label', champ.name.ru);

            const img = document.createElement('img');
            img.src = champ.iconUrl;
            img.alt = ""; // Decorative image
            img.className = 'w-full h-full object-cover block pointer-events-none';
            img.loading = 'lazy';
            img.onerror = () => { img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3Crect width='1' height='1' fill='%234a5568'/%3E%3C/svg%3E`; card.setAttribute('aria-label', `${champ.name.ru} (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏)`); };

            card.appendChild(img);

            // Add click listener for preview (check permission inside handler)
            card.addEventListener('click', () => handleChampionPreview(champ));

            card.addEventListener('mouseover', (event) => showChampionTooltip(event, champ));
            card.addEventListener('mouseout', hideChampionTooltip);
            card.addEventListener('focus', (event) => showChampionTooltip(event, champ));
            card.addEventListener('blur', hideChampionTooltip);
            return card;
        }

        function displayChampions() { if(!championGridElement) { console.error("displayChampions: championGridElement not found"); return; } const fragment = document.createDocumentFragment(); processedChampions.forEach(champ => { fragment.appendChild(createChampionCard(champ)); }); championGridElement.innerHTML = ''; championGridElement.appendChild(fragment); filterChampions(); }
        function updateDraftUI() {
            // console.log("DEBUG: updateDraftUI called. isDraftInitialized:", isDraftInitialized, "currentStep:", currentStep, "isDraftStarted:", isDraftStarted);
            if (!isDraftInitialized) return;
            document.querySelectorAll('.pick-slot, .ban-slot').forEach(el => { el.classList.remove('highlight-action', 'preview-flash', 'swap-selected'); });

            applyRolePermissions(currentUserRole);

            const draftOrder = getDraftOrder();
            const canConfirm = hasPermission('confirmAction', draftOrder[currentStep]?.team);
            if(confirmPickBanButton) confirmPickBanButton.disabled = !canConfirm || !previewedChampion || !isDraftStarted || isDraftComplete;

            const canUndo = hasPermission('undoAction', draftHistory[draftHistory.length - 1]?.team);
            if(undoButton) undoButton.disabled = !canUndo || draftHistory.length === 0 || !isDraftStarted;

            const canStart = hasPermission('startDraft');
            const canClear = hasPermission('clearDraft');
            const canReset = hasPermission('resetDraft');
            const canSwap = hasPermission('swapSides');
            const canToggleTimer = hasPermission('toggleTimerDuration');
            const canTogglePriority = hasPermission('togglePriorityFilter');
            const canNext = hasPermission('nextDraft');

            if (!isDraftStarted) {
                resetTimerDisplay();
                if(blueColumn) blueColumn.classList.add('draft-disabled');
                if(redColumn) redColumn.classList.add('draft-disabled');
                if(nextDraftButton) nextDraftButton.disabled = !canNext || true;
                if(swapButton) swapButton.disabled = !canSwap;
                if(clearPicksButton) clearPicksButton.disabled = !canClear || (draftHistory.length === 0 && Object.keys(pickNicknames).length === 0 && selectedChampions.size === 0 && globalBanHistory.length === 0);
                if(toggleTimerButton) toggleTimerButton.disabled = !canToggleTimer;
                if(priorityFilterButton) priorityFilterButton.disabled = !canTogglePriority;
                if(resetButton) resetButton.disabled = !canReset;
                if(timerDisplay) timerDisplay.disabled = !canStart;
            } else if (currentStep < draftOrder.length) {
                isDraftComplete = false;
                const action = draftOrder[currentStep];
                const activeSlot = document.getElementById(action.slot);
                const currentActionTeam = action.team;

                if (activeSlot) {
                    if (currentUserRole === 'admin' || currentUserRole === 'judge' || userTeamSide === currentActionTeam) {
                         activeSlot.classList.add('highlight-action');
                    }
                    const isConfirmed = draftHistory.some(entry => entry.slotId === action.slot);
                    if (!isConfirmed) {
                        const currentNickname = pickNicknames[action.slot] || '';
                        if (!activeSlot.classList.contains('preview-flash')) {
                            restoreSlotPlaceholder(activeSlot, action.slot, currentNickname);
                        }
                    }
                }
                if (!timerInterval && hasPermission('startDraft')) startTimer();
                if(nextDraftButton) nextDraftButton.disabled = true;
                if(timerDisplay) timerDisplay.disabled = true;
                if(swapButton) swapButton.disabled = true;
                if(toggleTimerButton) toggleTimerButton.disabled = true;
                if(priorityFilterButton) priorityFilterButton.disabled = true;
                if(clearPicksButton) clearPicksButton.disabled = !canClear;
                if(resetButton) resetButton.disabled = !canReset;
                if (championGridElement) championGridElement.style.pointerEvents = (currentUserRole === 'admin' || userTeamSide === currentActionTeam) ? 'auto' : 'none';

            } else { // Draft Complete
                isDraftComplete = true;
                stopTimer();
                if(timerDisplay) {
                    timerDisplay.textContent = "–î—Ä–∞—Ñ—Ç –ó–∞–≤–µ—Ä—à–µ–Ω!";
                    timerDisplay.classList.add('timer-disabled');
                    timerDisplay.disabled = true;
                    timerDisplay.title = '–î—Ä–∞—Ñ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω';
                }
                if(blueColumn) blueColumn.classList.remove('draft-disabled');
                if(redColumn) redColumn.classList.remove('draft-disabled');
                if(nextDraftButton) nextDraftButton.disabled = !canNext;
                if(swapButton) swapButton.disabled = !canSwap;
                if(clearPicksButton) clearPicksButton.disabled = !canClear;
                if(toggleTimerButton) toggleTimerButton.disabled = true;
                if(priorityFilterButton) priorityFilterButton.disabled = !canTogglePriority;
                if(resetButton) resetButton.disabled = !canReset;
                if (championGridElement) championGridElement.style.pointerEvents = 'none';
            }

            updateChampionAvailability();
            displayGloballyBanned();
            document.querySelectorAll('.pick-slot').forEach(slot => {
                const champId = getSlotChampionId(slot.id);
                slot.style.cursor = isDraftComplete && champId && can('swapSides') ? 'pointer' : 'default';
                slot.title = isDraftComplete && champId && can('swapSides') ? '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–±–º–µ–Ω–∞' : '';
            });
             updateNicknameEditability();
             // console.log("DEBUG: updateDraftUI finished.");
        }
        function updateChampionAvailability() { if (!isDraftInitialized) return; const combinedDisabled = new Set([...selectedChampions, ...globallyDisabledChampions]); document.querySelectorAll('.champion-card').forEach(card => { const champId = card.dataset.championId; const isDisabled = combinedDisabled.has(champId); const isSelected = selectedChampions.has(champId); card.classList.toggle('selected', isSelected); card.classList.toggle('disabled', isDisabled); card.disabled = isDisabled; card.setAttribute('aria-disabled', isDisabled.toString()); }); }
        function handleChampionPreview(champion) {
            console.log("handleChampionPreview called for:", champion.id);
            if (!isDraftStarted || isDraftComplete) { console.log("Preview denied: Draft not started or complete."); return; }
            const draftOrder = getDraftOrder();
            if (currentStep >= draftOrder.length) { console.log("Preview denied: Draft step out of bounds."); return; }

            const currentAction = draftOrder[currentStep];
            if (currentUserRole !== 'admin' && userTeamSide !== currentAction.team) {
                console.log(`Preview denied: Not turn for role ${currentUserRole} (side ${userTeamSide}) on team ${currentAction.team}'s action.`);
                return;
            }
             const permissionNeeded = currentAction.type === 'pick' ? 'pickChampion' : 'banChampion';
             if (!hasPermission(permissionNeeded, currentAction.team)) { console.log(`Preview denied: No permission for ${permissionNeeded}.`); return; }

            const isDisabled = selectedChampions.has(champion.id) || globallyDisabledChampions.has(champion.id);
            if (isDisabled) { showStatusMessage(`${champion.name.ru} —É–∂–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.`, 2000); console.log(`Preview denied: Champion ${champion.id} disabled.`); return; }

            const slotElement = document.getElementById(currentAction.slot);
            if (slotElement) {
                console.log(`Previewing ${champion.id} in slot ${currentAction.slot}`);
                document.querySelectorAll('.preview-flash').forEach(el => el.classList.remove('preview-flash'));
                previewedChampion = champion;
                const existingNickname = pickNicknames[currentAction.slot] || '';
                fillSlot(slotElement, champion, currentAction.type, existingNickname);
                slotElement.classList.add('preview-flash');
                if(confirmPickBanButton) confirmPickBanButton.disabled = !hasPermission('confirmAction', currentAction.team);
            } else { console.warn(`Preview failed: Slot element ${currentAction.slot} not found.`); }
         }
        function handleConfirmPickBan() {
            console.log("handleConfirmPickBan called");
            if (!previewedChampion || !isDraftStarted || isDraftComplete) { console.log("Confirm denied: No preview, draft not started, or complete."); return; }
            const draftOrder = getDraftOrder();
             if (currentStep >= draftOrder.length) { console.log("Confirm denied: Draft step out of bounds."); return; }

            const currentAction = draftOrder[currentStep];
             if ((currentUserRole !== 'admin' && userTeamSide !== currentAction.team) || !hasPermission('confirmAction', currentAction.team)) {
                 console.log(`Confirm denied: Not turn or no permission for role ${currentUserRole} on team ${currentAction.team}'s action.`);
                 return;
             }

            const championToConfirm = previewedChampion;
            const slotElement = document.getElementById(currentAction.slot);
            const isDisabled = selectedChampions.has(championToConfirm.id) || globallyDisabledChampions.has(championToConfirm.id);

            if (!slotElement || isDisabled) { console.warn("Confirmation failed: Slot not found or champion unavailable."); previewedChampion = null; if(confirmPickBanButton) confirmPickBanButton.disabled = true; if (slotElement) slotElement.classList.remove('preview-flash'); return; }

            console.log(`Confirming ${championToConfirm.id} for slot ${currentAction.slot}`);
            slotElement.classList.remove('preview-flash');
            const previousNickname = pickNicknames[currentAction.slot] || '';
            selectedChampions.add(championToConfirm.id);
            draftHistory.push({ championId: championToConfirm.id, slotId: currentAction.slot, step: currentStep, previousNickname: previousNickname, type: currentAction.type, team: currentAction.team });
            currentStep++;
            previewedChampion = null;
            resetTimerDisplay();
            updateDraftUI();
            filterChampions();
        }
        function fillSlot(slotElement, champion, type, nicknameText = '') { if (!slotElement || !champion) return; slotElement.innerHTML = ''; slotElement.classList.remove('preview-flash'); const img = document.createElement('img'); img.src = type === 'pick' ? champion.splashUrl : champion.iconUrl; img.alt = champion.name.ru; img.className = 'w-full h-full object-cover block absolute inset-0 z-0 pointer-events-none'; img.onerror = () => { const errorSpan = document.createElement('span'); errorSpan.className = 'text-[1.5vmin] text-red-400'; errorSpan.textContent = 'Err'; slotElement.innerHTML = ''; slotElement.appendChild(errorSpan); if (type === 'pick') { addNicknameInput(slotElement, nicknameText); } }; slotElement.appendChild(img); if (type === 'pick') { addNicknameInput(slotElement, nicknameText); slotElement.dataset.championId = champion.id; } else { delete slotElement.dataset.championId; } slotElement.setAttribute('aria-label', `${slotElement.ariaLabel.split(':')[0]}: ${champion.name.ru}`); }
        function addNicknameInput(slotElement, text = '') {
             const nicknameInput = document.createElement('div');
             nicknameInput.spellcheck = false;
             nicknameInput.className = 'nickname-input';
             nicknameInput.textContent = text || '';
             nicknameInput.dataset.slotId = slotElement.id;
             const canEdit = hasPermission('editNicknames');
             nicknameInput.contentEditable = canEdit;
             nicknameInput.style.cursor = canEdit ? 'text' : 'default';

             if (canEdit) {
                 nicknameInput.addEventListener('input', (e) => {
                     const slotId = e.target.dataset.slotId;
                     if (slotId) { pickNicknames[slotId] = e.target.textContent.trim(); console.log("Nickname updated:", pickNicknames); }
                 });
                 nicknameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } });
             }
             slotElement.appendChild(nicknameInput);
         }
        function restoreSlotPlaceholder(slotElement, slotId, nicknameText = '') { if (!slotElement) return; slotElement.innerHTML = ''; slotElement.classList.remove('preview-flash', 'swap-selected', 'highlight-action'); delete slotElement.dataset.championId; slotElement.style.backgroundImage = ''; slotElement.style.cursor = 'default'; slotElement.title = ''; slotElement.setAttribute('aria-label', `${slotElement.ariaLabel.split(':')[0]}: Empty`); if (slotId && slotId.includes('-pick-')) { addNicknameInput(slotElement, nicknameText); pickNicknames[slotId] = nicknameText; } else { delete pickNicknames[slotId]; } }
        function getSlotChampionId(slotId) { const slotElement = document.getElementById(slotId); return slotElement ? slotElement.dataset.championId : null; }
        function handleUndo() {
             console.log("handleUndo called");
             if (draftHistory.length === 0 || !isDraftStarted) { console.log("Undo denied: No history or draft not started."); return; }
             const lastAction = draftHistory[draftHistory.length - 1];

             if (!hasPermission('undoAction', lastAction.team)) {
                 console.log(`Undo denied: No permission for role ${currentUserRole} on team ${lastAction.team}'s action.`);
                 showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.", 2000);
                 return;
             }

             deselectSwapSlots();
             draftHistory.pop();
             if (!lastAction) return;
             console.log("Undoing action:", lastAction);
             currentStep = lastAction.step;
             selectedChampions.delete(lastAction.championId);
             const slotElement = document.getElementById(lastAction.slotId);
             if (slotElement) {
                 restoreSlotPlaceholder(slotElement, lastAction.slotId, lastAction.previousNickname);
             }
             isDraftComplete = false;
             previewedChampion = null;
             resetTimerDisplay();
             updateDraftUI();
             filterChampions();
             showStatusMessage("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", 1500);
        }

        // --- Reset Functions (Draft Specific - with permission checks) ---
        function resetDraftFull(force = false) {
            console.log("resetDraftFull called, force:", force);
            if (!hasPermission('resetDraft')) {
                 showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–±—Ä–æ—Å–∞ –¥—Ä–∞—Ñ—Ç–∞.", 2000);
                 return;
            }
            if (!force && !confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—Å–∏—Ç—å –¥—Ä–∞—Ñ—Ç (–≤–∫–ª—é—á–∞—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±–∞–Ω—ã)?")) {
                console.log("Full reset cancelled by user.");
                return;
            }
            console.log("resetDraftFull proceeding...");

            currentStep = 0; selectedChampions.clear(); draftHistory = []; pickNicknames = {}; globallyDisabledChampions.clear(); globalBanHistory = []; isDraftComplete = false; isDraftStarted = false; previewedChampion = null; deselectSwapSlots(); stopTimer(); draftTimerDuration = 30; resetTimerDisplay();
            document.querySelectorAll('.pick-slot, .ban-slot').forEach((slot) => { restoreSlotPlaceholder(slot, slot.id, ''); slot.classList.remove('highlight-action', 'preview-flash'); });
            if (blueTeamNameH2) blueTeamNameH2.textContent = localStorage.getItem('lobbyTeam1Name') || '–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞';
            if (redTeamNameH2) redTeamNameH2.textContent = localStorage.getItem('lobbyTeam2Name') || '–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞';
            if (blueScoreEl) blueScoreEl.textContent = ''; if (redScoreEl) redScoreEl.textContent = '';
            if(blueColumn) blueColumn.classList.add('draft-disabled'); if(redColumn) redColumn.classList.add('draft-disabled');
            if(championSearch) championSearch.value = ''; currentRoleFilter = 'All'; if(filterButtons) filterButtons.forEach(btn => { if(btn) btn.classList.toggle('active', btn.dataset.role === 'All'); }); isPriorityFilterActive = false; if (priorityFilterButton) { priorityFilterButton.classList.remove('active'); priorityFilterButton.setAttribute('aria-pressed', 'false'); }
            displayGloballyBanned(); updateChampionAvailability(); filterChampions(); updateDraftUI();
            showStatusMessage("–î—Ä–∞—Ñ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω.", 2000);
        }

        function resetCurrentGamePicksBans(force = false, keepGlobal = false) {
             console.log("resetCurrentGamePicksBans called, force:", force, "keepGlobal:", keepGlobal);
             if (!hasPermission('clearDraft')) {
                 showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥—Ä–∞—Ñ—Ç–∞.", 2000);
                 return;
             }
            if (!force && isDraftStarted && !isDraftComplete) {
                if (!confirm("–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –¥—Ä–∞—Ñ—Ç –∏ –æ—á–∏—Å—Ç–∏—Ç—å –ø–∏–∫–∏/–±–∞–Ω—ã —ç—Ç–æ–π –∏–≥—Ä—ã" + (keepGlobal ? "?" : " (–≤–∫–ª—é—á–∞—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ)?"))) {
                    console.log("resetCurrentGamePicksBans cancelled by user during draft.");
                    return;
                }
            }
            console.log("resetCurrentGamePicksBans proceeding...");

            currentStep = 0;
            selectedChampions.clear(); // Clear current selections
            draftHistory = [];
            if (!keepGlobal) {
                globallyDisabledChampions.clear();
                globalBanHistory = [];
                console.log("Global bans cleared.");
            } else {
                 console.log("Keeping global bans for next draft.");
                 // Re-populate selectedChampions with global bans if keeping them
                 globallyDisabledChampions.forEach(champId => selectedChampions.add(champId));
            }

            isDraftComplete = false; isDraftStarted = false; previewedChampion = null; deselectSwapSlots(); stopTimer(); resetTimerDisplay();
            document.querySelectorAll('.pick-slot, .ban-slot').forEach((slot) => {
                const currentNickname = pickNicknames[slot.id] || '';
                restoreSlotPlaceholder(slot, slot.id, currentNickname);
                slot.classList.remove('highlight-action', 'preview-flash');
            });
            if(blueColumn) blueColumn.classList.add('draft-disabled');
            if(redColumn) redColumn.classList.add('draft-disabled');
            displayGloballyBanned();
            updateChampionAvailability(); // Update availability based on (potentially kept) global bans
            filterChampions();
            updateDraftUI();
            showStatusMessage(keepGlobal ? "–¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞ –æ—á–∏—â–µ–Ω–∞." : "–ü–∏–∫–∏/–±–∞–Ω—ã —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã (–≤–∫–ª—é—á–∞—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ) –æ—á–∏—â–µ–Ω—ã.", 2000);
        }


        // --- Other Handlers (Draft Specific - with permission checks) ---
        function handleStartDraft() {
            console.log("handleStartDraft called");
            if (!hasPermission('startDraft')) { console.log("Start denied: No permission."); return; }
            if (!isDraftStarted) { console.log("Starting draft..."); isDraftStarted = true; if(blueColumn) blueColumn.classList.remove('draft-disabled'); if(redColumn) redColumn.classList.remove('draft-disabled'); updateDraftUI(); }
            else { console.log("Start denied: Draft already started."); }
         }
        const debouncedFilter = debounce(() => { filterChampions(); }, 250);
        function filterChampions() {
            if (!isDraftInitialized || !championSearch || !championGridElement) return;
            const searchTerm = championSearch.value.toLowerCase().trim();
            let visibleCount = 0;
             const priorityChampions = new Set([/* Placeholder */]);

            championGridElement.querySelectorAll('.champion-card').forEach(card => {
                const champId = card.dataset.championId;
                const nameEn = card.dataset.championNameEn || '';
                const nameRu = card.dataset.championNameRu || '';
                const champRoles = card.dataset.roles ? card.dataset.roles.split(',') : [];

                const searchMatch = nameEn.includes(searchTerm) || nameRu.includes(searchTerm) || champId.toLowerCase().includes(searchTerm);
                const roleMatch = currentRoleFilter === 'All' || champRoles.includes(currentRoleFilter);
                const isPriority = priorityChampions.has(champId);
                const hideByPriorityFilter = isPriorityFilterActive && !isPriority;

                const isVisible = searchMatch && roleMatch && !hideByPriorityFilter;

                card.style.display = isVisible ? 'flex' : 'none';
                if (isVisible) visibleCount++;

                const isDisabled = selectedChampions.has(champId) || globallyDisabledChampions.has(champId);
                card.classList.toggle('disabled', isDisabled);
                card.disabled = isDisabled;
                card.setAttribute('aria-disabled', isDisabled.toString());
                card.classList.toggle('selected', selectedChampions.has(champId));
            });
        }
        function deselectSwapSlots() { if (selectedSwapSlotId) { const prevSelected = document.getElementById(selectedSwapSlotId); if (prevSelected) { prevSelected.classList.remove('swap-selected'); } selectedSwapSlotId = null; } }
        function handlePickContainerClick(event) {
             console.log("handlePickContainerClick called on:", event.target);
             if (event.target.classList.contains('nickname-input')) { return; }
             if (!hasPermission('swapSides')) { console.log("Pick container click denied: No swap permission."); return; }
             const clickedSlot = event.target.closest('.pick-slot');
             if (!isDraftComplete || !clickedSlot || !clickedSlot.dataset.championId) { console.log("Pick container click ignored: Draft not complete or empty slot."); deselectSwapSlots(); return; }

             const clickedSlotId = clickedSlot.id;
             console.log("Clicked slot:", clickedSlotId);
             if (!selectedSwapSlotId) {
                 selectedSwapSlotId = clickedSlotId;
                 clickedSlot.classList.add('swap-selected');
                 console.log("Swap select:", selectedSwapSlotId);
             } else {
                 if (selectedSwapSlotId === clickedSlotId) {
                     deselectSwapSlots();
                     console.log("Swap deselect");
                 } else {
                     const firstSlot = document.getElementById(selectedSwapSlotId);
                     if (!firstSlot) { console.warn("Swap failed: First slot not found."); deselectSwapSlots(); return; }
                     const team1 = selectedSwapSlotId.startsWith('blue') ? 'blue' : 'red';
                     const team2 = clickedSlotId.startsWith('blue') ? 'blue' : 'red';
                     if (team1 === team2) {
                         console.log("Attempting swap between:", selectedSwapSlotId, clickedSlotId);
                         const champId1 = firstSlot.dataset.championId;
                         const champId2 = clickedSlot.dataset.championId;
                         const champ1 = getChampionById(champId1);
                         const champ2 = getChampionById(champId2);
                         const nick1 = pickNicknames[selectedSwapSlotId] || '';
                         const nick2 = pickNicknames[clickedSlotId] || '';
                         pickNicknames[selectedSwapSlotId] = nick2;
                         pickNicknames[clickedSlotId] = nick1;
                         if (champ1 && champ2) {
                             fillSlot(firstSlot, champ2, 'pick', nick2);
                             fillSlot(clickedSlot, champ1, 'pick', nick1);
                             showStatusMessage(`–û–±–º–µ–Ω: ${champ1.name.ru} <-> ${champ2.name.ru}`, 2000);
                         } else { console.warn("Swap failed: Champion data missing."); }
                         deselectSwapSlots();
                     } else {
                         console.log("Swap select (different team):", clickedSlotId);
                         deselectSwapSlots();
                         selectedSwapSlotId = clickedSlotId;
                         clickedSlot.classList.add('swap-selected');
                     }
                 }
             }
         }
        function handleSwapTeams() {
             console.log("handleSwapTeams called");
             if (!hasPermission('swapSides')) {
                 showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω.", 2000);
                 return;
             }
             try {
                 const tempName = blueTeamNameH2.textContent; blueTeamNameH2.textContent = redTeamNameH2.textContent; redTeamNameH2.textContent = tempName;
                 const tempScore = blueScoreEl.textContent; blueScoreEl.textContent = redScoreEl.textContent; redScoreEl.textContent = tempScore;
                 const storedName1 = localStorage.getItem('lobbyTeam1Name');
                 const storedName2 = localStorage.getItem('lobbyTeam2Name');
                 localStorage.setItem('lobbyTeam1Name', storedName2 || '–ö—Ä–∞—Å–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞');
                 localStorage.setItem('lobbyTeam2Name', storedName1 || '–°–∏–Ω—è—è –ö–æ–º–∞–Ω–¥–∞');

                 console.log("Swapping global ban history teams..."); globalBanHistory.forEach(ban => { ban.team = ban.team === 'blue' ? 'red' : 'blue'; }); displayGloballyBanned();

                 if (isDraftComplete || !isDraftStarted) {
                     console.log("Swapping picks/bans/nicknames...");
                     const newPickNicknames = {}; const newSelectedChampions = new Set(); const newBluePicks = []; const newRedPicks = []; const newBlueBans = []; const newRedBans = [];
                     const currentBlueBans = []; const currentRedBans = [];

                     // Collect current state before clearing
                     for(let i=1; i<=5; i++) {
                         const blueBanSlot = document.getElementById(`blue-ban-${i}`);
                         const redBanSlot = document.getElementById(`red-ban-${i}`);
                         const blueBanImg = blueBanSlot ? blueBanSlot.querySelector('img') : null;
                         const redBanImg = redBanSlot ? redBanSlot.querySelector('img') : null;
                         // Find the actual champion ID from history for bans
                         if(blueBanImg) currentBlueBans.push(draftHistory.find(a => a.slotId === `blue-ban-${i}`)?.championId);
                         if(redBanImg) currentRedBans.push(draftHistory.find(a => a.slotId === `red-ban-${i}`)?.championId);

                         const bluePickSlotId = `blue-pick-${i}`;
                         const redPickSlotId = `red-pick-${i}`;
                         const blueChampId = getSlotChampionId(bluePickSlotId);
                         const redChampId = getSlotChampionId(redPickSlotId);
                         const blueNick = pickNicknames[bluePickSlotId] || '';
                         const redNick = pickNicknames[redPickSlotId] || '';

                         if(redChampId) newBluePicks.push({ slotId: bluePickSlotId, champId: redChampId, nick: redNick });
                         if(blueChampId) newRedPicks.push({ slotId: redPickSlotId, champId: blueChampId, nick: blueNick });
                         newPickNicknames[bluePickSlotId] = redNick;
                         newPickNicknames[redPickSlotId] = blueNick;
                     }
                     // Assign swapped bans
                     currentRedBans.forEach((champId, index) => { if(champId) newBlueBans.push({ slotId: `blue-ban-${index+1}`, championId: champId }); });
                     currentBlueBans.forEach((champId, index) => { if(champId) newRedBans.push({ slotId: `red-ban-${index+1}`, championId: champId }); });

                     pickNicknames = newPickNicknames;

                     // Clear all slots first
                     document.querySelectorAll('.pick-slot, .ban-slot').forEach(slot => restoreSlotPlaceholder(slot, slot.id, ''));

                     // Re-fill slots with swapped data
                     newBlueBans.forEach(b => { const champ = getChampionById(b.championId); if(champ) fillSlot(document.getElementById(b.slotId), champ, 'ban'); if(b.championId) newSelectedChampions.add(b.championId); });
                     newRedBans.forEach(b => { const champ = getChampionById(b.championId); if(champ) fillSlot(document.getElementById(b.slotId), champ, 'ban'); if(b.championId) newSelectedChampions.add(b.championId); });
                     newBluePicks.forEach(p => { const champ = getChampionById(p.champId); if(champ) fillSlot(document.getElementById(p.slotId), champ, 'pick', p.nick); if(p.champId) newSelectedChampions.add(p.champId); });
                     newRedPicks.forEach(p => { const champ = getChampionById(p.champId); if(champ) fillSlot(document.getElementById(p.slotId), champ, 'pick', p.nick); if(p.champId) newSelectedChampions.add(p.champId); });

                     selectedChampions = newSelectedChampions; // Update the main selected set
                     deselectSwapSlots();
                     showStatusMessage("–ö–æ–º–∞–Ω–¥—ã –ø–æ–º–µ–Ω—è–ª–∏—Å—å –º–µ—Å—Ç–∞–º–∏ (–ø–∏–∫–∏/–±–∞–Ω—ã/–Ω–∏–∫–∏/–≥–ª–æ–±. –±–∞–Ω—ã).", 2000);
                 } else {
                     console.warn("Attempted to swap teams during an active draft. Only names/scores/global bans swapped.");
                     showStatusMessage("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –ø–∏–∫–∏/–±–∞–Ω—ã –≤–æ –≤—Ä–µ–º—è –¥—Ä–∞—Ñ—Ç–∞. –°–º–µ–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞/—Å—á–µ—Ç/–≥–ª–æ–±. –±–∞–Ω—ã.", 3000);
                 }
                 updateChampionAvailability();
                 updateDraftUI(); // Refresh UI after swap
             } catch (error) { console.error("Error in handleSwapTeams:", error); showStatusMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–º–∞–Ω–¥.", 3000); }
         }
        function handleToggleTimer() {
             console.log("handleToggleTimer called");
             if (!hasPermission('toggleTimerDuration')) { showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–º–µ–Ω—ã —Ç–∞–π–º–µ—Ä–∞.", 2000); return; }
             if (isDraftStarted) { console.log("Toggle timer denied: Draft started."); return; }
             draftTimerDuration = draftTimerDuration === 30 ? 45 : 30; resetTimerDisplay(); toggleTimerButton.title = `–°–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —Ç–∞–π–º–µ—Ä–∞ (${draftTimerDuration === 30 ? '-> 45—Å' : '-> 30—Å'})`; showStatusMessage(`–í—Ä–µ–º—è —Ç–∞–π–º–µ—Ä–∞: ${draftTimerDuration} —Å–µ–∫.`, 1500); console.log("Timer duration set to:", draftTimerDuration);
         }
        function handleRoleFilterClick(event) {
             console.log("handleRoleFilterClick called for role:", event.currentTarget?.dataset?.role);
             if (!hasPermission('useRoleFilters')) { console.log("Role filter denied: No permission."); return; }
             const clickedButton = event.currentTarget; if (!clickedButton) return; currentRoleFilter = clickedButton.dataset.role; filterButtons.forEach(btn => { if(btn) btn.classList.remove('active'); }); clickedButton.classList.add('active'); filterChampions();
         }
        function handlePriorityFilterToggle() {
             console.log("handlePriorityFilterToggle called");
             if (!hasPermission('togglePriorityFilter')) { showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞.", 2000); return; }
            isPriorityFilterActive = !isPriorityFilterActive;
            if(priorityFilterButton) {
                priorityFilterButton.classList.toggle('active', isPriorityFilterActive);
                priorityFilterButton.setAttribute('aria-pressed', isPriorityFilterActive.toString());
                priorityFilterButton.title = isPriorityFilterActive ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —á–µ–º–ø–∏–æ–Ω–æ–≤';
            }
            console.log('Priority filter active:', isPriorityFilterActive);
            filterChampions();
            showStatusMessage("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–µ–º–ø–∏–æ–Ω–æ–≤ –º–µ–∂–¥—É LoL –∏ Wild Rift.", 2000);
        }
        function displayGloballyBanned() { if (!globalBansBlueContainer || !globalBansRedContainer || !globallyBannedDisplay) return; globalBansBlueContainer.innerHTML = ''; globalBansRedContainer.innerHTML = ''; if (globalBanHistory.length > 0) { globallyBannedDisplay.classList.remove('hidden'); const blueFragment = document.createDocumentFragment(); const redFragment = document.createDocumentFragment(); globalBanHistory.forEach(banInfo => { const champ = getChampionById(banInfo.championId); if (champ) { const iconDiv = document.createElement('div'); iconDiv.className = 'global-ban-icon'; const banTeamText = banInfo.team === 'blue' ? '—Å–∏–Ω–∏–º–∏' : '–∫—Ä–∞—Å–Ω—ã–º–∏'; iconDiv.title = `${champ.name.ru} (–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ${banTeamText} –≤ –ø—Ä–µ–¥. –∏–≥—Ä–µ)`; iconDiv.setAttribute('aria-label', iconDiv.title); const img = document.createElement('img'); img.src = champ.iconUrl; img.alt = ""; img.loading = 'lazy'; img.onerror = () => { img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3Crect width='1' height='1' fill='%234a5568'/%3E%3C/svg%3E`; }; iconDiv.appendChild(img); if (banInfo.team === 'blue') { blueFragment.appendChild(iconDiv); } else { redFragment.appendChild(iconDiv); } } }); globalBansBlueContainer.appendChild(blueFragment); globalBansRedContainer.appendChild(redFragment); } else { globallyBannedDisplay.classList.add('hidden'); } }
        function handleNextDraft() {
             console.log("handleNextDraft called");
             if (!hasPermission('nextDraft')) { showStatusMessage("–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥—Ä–∞—Ñ—Ç—É.", 2000); return; }
            if (!isDraftComplete) { console.warn("handleNextDraft: Draft not complete."); showStatusMessage("–î—Ä–∞—Ñ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.", 3000); return; }
            let addedBansCount = 0;
            // Add only *picks* from the completed draft history to global bans
            draftHistory.forEach(action => {
                if (action.type === 'pick' && !globallyDisabledChampions.has(action.championId)) {
                    globalBanHistory.push({ championId: action.championId, team: action.team });
                    globallyDisabledChampions.add(action.championId);
                    addedBansCount++;
                }
            });
            console.log(`handleNextDraft: Added ${addedBansCount} champions to global bans.`);
            resetCurrentGamePicksBans(false, true); // Keep global bans
            showStatusMessage("–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥—Ä–∞—Ñ—Ç—É. –ü–∏–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–≥—Ä—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.", 2500);
        }

        // --- Draft Order Definition ---
        function getDraftOrder() {
            return [
                { team: 'blue', type: 'ban', slot: 'blue-ban-1' }, { team: 'red', type: 'ban', slot: 'red-ban-1' },
                { team: 'blue', type: 'ban', slot: 'blue-ban-2' }, { team: 'red', type: 'ban', slot: 'red-ban-2' },
                { team: 'blue', type: 'ban', slot: 'blue-ban-3' }, { team: 'red', type: 'ban', slot: 'red-ban-3' },
                { team: 'blue', type: 'pick', slot: 'blue-pick-1' }, { team: 'red', type: 'pick', slot: 'red-pick-1' },
                { team: 'red', type: 'pick', slot: 'red-pick-2' }, { team: 'blue', type: 'pick', slot: 'blue-pick-2' },
                { team: 'blue', type: 'pick', slot: 'blue-pick-3' }, { team: 'red', type: 'pick', slot: 'red-pick-3' },
                { team: 'red', type: 'ban', slot: 'red-ban-4' }, { team: 'blue', type: 'ban', slot: 'blue-ban-4' },
                { team: 'red', type: 'ban', slot: 'red-ban-5' }, { team: 'blue', type: 'ban', slot: 'blue-ban-5' },
                { team: 'red', type: 'pick', slot: 'red-pick-4' }, { team: 'blue', type: 'pick', slot: 'blue-pick-4' },
                { team: 'blue', type: 'pick', slot: 'blue-pick-5' }, { team: 'red', type: 'pick', slot: 'red-pick-5' },
            ];
        }


        // --- Tooltip Functions (Draft Specific) ---
        let tooltipTimeout;
        function showChampionTooltip(event, champion) { clearTimeout(tooltipTimeout); tooltipTimeout = setTimeout(() => { if (!championTooltip || !champion) return; championTooltip.innerHTML = `<strong class="tooltip-title">${champion.name.ru}</strong><span class="tooltip-name">${champion.title.ru}</span>`; championTooltip.style.visibility = 'hidden'; championTooltip.style.display = 'block'; const tooltipRect = championTooltip.getBoundingClientRect(); championTooltip.style.visibility = ''; championTooltip.style.display = ''; const rect = event.target.getBoundingClientRect(); let top = rect.top - tooltipRect.height - 8; let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); if (top < 0) { top = rect.bottom + 8; } if (left < 0) { left = 5; } else if (left + tooltipRect.width > window.innerWidth) { left = window.innerWidth - tooltipRect.width - 5; } championTooltip.style.left = `${left}px`; championTooltip.style.top = `${top}px`; championTooltip.classList.add('visible'); }, 100); }
        function hideChampionTooltip() { clearTimeout(tooltipTimeout); if (championTooltip) { championTooltip.classList.remove('visible'); } }

        // --- Initial App Setup ---
         const initialRole = getRoleFromHash();
         if (initialRole) {
             currentUserRole = initialRole;
             navigateTo('draft');
         } else {
             navigateTo('home');
         }

    }); // End DOMContentLoaded
</script>

</body>
</html>